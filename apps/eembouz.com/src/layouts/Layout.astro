---
import Scripts from "../components/Scripts.astro";
import Seo from "../components/Seo.astro";
import Footer from "../components/shared/Footer.astro";
import { ClientRouter } from "astro:transitions";
import "@portfolio/ui/GlobalCSS";
import Header from "../components/shared/Header.astro";
import BlurEffect from "../components/BlurEffect.astro";
import ThemeManager from "@portfolio/ui/ThemeManager";

const {
  title,
  description,
  image,
  url = Astro.url.href,
  typeContent,
} = Astro.props;
---

<!doctype html>
<html lang="fr">
  <head>
    <Seo
      title={title}
      description={description}
      typeContent={typeContent}
      image={image}
      url={url}
    />
    <Scripts />
    <ThemeManager />
  </head>
  <body>
    <BlurEffect />

    <div class="bg-noise">
      <div class="page-wrapper">
        <Header />
        <slot />
        <Footer />
      </div>
    </div>
    <ClientRouter />
  </body>
</html>

<style>
  .page-wrapper {
    overflow: hidden;
  }
</style>

<script>
  import { langs } from "../../config.ts";

  function trim(str: string, char: string): string {
    if (char.length !== 1) {
      throw new Error("Char must be single character");
    }
    if (str == null || str.length === 0) return str;
    if (!char) return str;

    const c = char.charCodeAt(0);
    let start = 0;
    let end = str.length - 1;
    while (start <= end && str.charCodeAt(start) === c) start++;
    while (end >= start && str.charCodeAt(end) === c) end--;
    return str.slice(start, end + 1);
  }

  function redirectLang() {
    const storedLang = localStorage.getItem("lang");
    const currentPath = window.location.pathname;
    const browserLang = navigator.language.split("-")[0].toLowerCase();

    // Extraire la langue de l'URL si présente
    const pathLang = currentPath.split("/")[1];
    const isValidPathLang = langs.includes(pathLang as any);

    // Si l'URL contient déjà une langue valide, l'utiliser et la stocker
    if (isValidPathLang && pathLang !== "fr") {
      localStorage.setItem("lang", pathLang);
      return;
    }

    if (storedLang) {
      if (storedLang !== "fr" && !currentPath.startsWith("/" + storedLang)) {
        window.location.href = "/" + trim(storedLang + currentPath, "/");
      }
      return;
    }

    let targetLang = "fr";

    if (langs.includes(browserLang as any)) {
      targetLang = browserLang;
    } else if (browserLang !== "fr") {
      targetLang = "en";
    }

    localStorage.setItem("lang", targetLang);

    if (targetLang !== "fr" && !currentPath.startsWith("/" + targetLang)) {
      window.location.href = "/" + trim(targetLang + currentPath, "/");
    }
  }

  redirectLang();

  document.addEventListener("astro:page-load", () => {
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
  });
</script>
