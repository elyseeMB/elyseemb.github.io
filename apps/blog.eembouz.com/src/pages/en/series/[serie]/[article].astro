---
import type { GetStaticPaths } from "astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import { filterSeries } from "../../../../libs/i18n.ts";
import PageSingleSerie from "../../../series/[serie]/_page_single_serie.astro";

interface Props {
  article: CollectionEntry<"series">;
  serie: CollectionEntry<"series">;
  relatedPosts: CollectionEntry<"series">["data"]["relatedPosts"][];
}

export const getStaticPaths = (async () => {
  const series = await getCollection("series", filterSeries("en"));

  const seriesIndex = series.filter((item) => item.id.endsWith("__index__"));

  const paths = [];

  for (const serie of seriesIndex) {
    const { relatedPosts } = serie.data;

    if (relatedPosts) {
      for (const post of relatedPosts) {
        const article = await getEntry(post.collection, post.id);

        const allRelatedPosts = await Promise.all(
          relatedPosts.map(
            async (item) => await getEntry(item.collection, item.id)
          )
        );

        paths.push({
          params: {
            serie: serie.id.split("/")[1],
            article: post.id.split("/")[2],
          },
          props: {
            article,
            serie,
            relatedPosts: allRelatedPosts,
          },
        });
      }
    }
  }

  return paths;
}) satisfies GetStaticPaths;
---

<PageSingleSerie {...Astro.props} />
