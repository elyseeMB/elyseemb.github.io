---
import Scripts from "../components/Scripts.astro";
import Seo from "../components/Seo.astro";
import Footer from "../components/shared/Footer.astro";
import Header from "../components/shared/Header.astro";
import { ClientRouter } from "astro:transitions";

import "@portfolio/ui/GlobalCSS";
import ThemeManager from "@portfolio/ui/ThemeManager";
import BlurEffect from "../components/BlurEffect.astro";

const {
  title,
  description,
  author,
  publishedDate,
  image,
  url = Astro.url.href,
  typeContent,
} = Astro.props;
---

<html lang="fr">
  <head>
    <Seo
      title={title}
      author={author}
      publishedDate={publishedDate}
      description={description}
      typeContent={typeContent}
      image={image}
      url={url}
    />
    <Scripts />
    <ThemeManager />
  </head>
  <body>
    <BlurEffect />
    <Header />
    <div class="page-wrapper">
      <slot />
    </div>
    <Footer />
    <ClientRouter />
  </body>
</html>

<script>
  import { langs } from "../../config.ts";

  function trim(str: string, char: string): string {
    if (char.length !== 1) {
      throw new Error("Char must be single character");
    }
    if (str == null || str.length === 0) return str;
    if (!char) return str;

    const c = char.charCodeAt(0);
    let start = 0;
    let end = str.length - 1;
    while (start <= end && str.charCodeAt(start) === c) start++;
    while (end >= start && str.charCodeAt(end) === c) end--;
    return str.slice(start, end + 1);
  }

  function redirectLang() {
    const storedLang = localStorage.getItem("lang");
    const currentPath = window.location.pathname;
    const browserLang = navigator.language.split("-")[0].toLowerCase();

    // Extraire la langue de l'URL si présente
    const pathLang = currentPath.split("/")[1];
    const isValidPathLang = langs.includes(pathLang as any);

    // Si l'URL contient déjà une langue valide, l'utiliser et la stocker
    if (isValidPathLang && pathLang !== "fr") {
      localStorage.setItem("lang", pathLang);
      return;
    }

    if (storedLang) {
      if (storedLang !== "fr" && !currentPath.startsWith("/" + storedLang)) {
        window.location.href = "/" + trim(storedLang + currentPath, "/");
      }
      return;
    }

    let targetLang = "fr";

    if (langs.includes(browserLang as any)) {
      targetLang = browserLang;
    } else if (browserLang !== "fr") {
      targetLang = "en";
    }

    localStorage.setItem("lang", targetLang);

    if (targetLang !== "fr" && !currentPath.startsWith("/" + targetLang)) {
      window.location.href = "/" + trim(targetLang + currentPath, "/");
    }
  }

  redirectLang();
</script>

<style is:global>
  pre.astro-code,
  pre.astro-code span {
    background-color: transparent !important;
  }

  pre.astro-code code {
    counter-reset: step;
    counter-increment: step 0;
    display: grid;
  }

  pre.astro-code .line::before {
    content: counter(step);
    counter-increment: step;
    width: 1rem;
    margin-right: 1.5rem;
    display: inline-block;
    text-align: right;
    color: var(--color-secondary);
    font-size: 0.8rem;
    user-select: none;
    opacity: 0.5;
  }
</style>
