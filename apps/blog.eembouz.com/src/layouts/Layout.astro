---
import Scripts from "../components/Scripts.astro";
import Seo from "../components/Seo.astro";
import Footer from "../components/shared/Footer.astro";
import Header from "../components/shared/Header.astro";

import "@portfolio/ui/GlobalCSS";

const {
  title,
  description,
  author,
  publishedDate,
  image,
  url = Astro.url.href,
  typeContent,
} = Astro.props;
---

<!doctype html>
<html lang="fr">
  <Seo
    title={title}
    author={author}
    publishedDate={publishedDate}
    description={description}
    typeContent={typeContent}
    image={image}
    url={url}
  />
  <Scripts />

  <body>
    <div class="bg-noise">
      <div class="page-wrapper">
        <Header />
        <slot />
        <Footer />
      </div>
    </div>
  </body>
</html>

<script>
  import { langs } from "../../config.ts";

  export function trim(str: string, char: string): string {
    if (char.length !== 1) {
      throw new Error("");
    }
    // Fast pointer-based trim of a single character from both ends.
    // Avoids regex and allocations; uses code-point comparison for speed.
    if (str == null || str.length === 0) return str;
    if (!char) return str;

    const c = char.charCodeAt(0);
    let start = 0;
    let end = str.length - 1;
    while (start <= end && str.charCodeAt(start) === c) start++;
    while (end >= start && str.charCodeAt(end) === c) end--;
    return str.slice(start, end + 1);
  }

  function redirectLang() {
    const lang = localStorage.getItem("lang");
    // The check was already done in the past, do nothing
    if (lang !== null) {
      return;
    }

    for (const lang of langs) {
      if (!navigator.language.includes(lang)) {
        continue;
      }

      // User is already on a translated content, do nothing
      if (window.location.href.includes(`/${lang}`)) {
        localStorage.setItem("lang", lang);
        continue;
      }

      // Redirect to the translated content
      localStorage.setItem("lang", lang);
      window.location.href =
        "/" + trim(`${lang}${window.location.pathname}`, "/");
    }
  }
  // Disable lang redirection while the translations are being worked
  redirectLang();
</script>
