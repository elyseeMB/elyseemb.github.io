name: ðŸš€ Hybrid Multi-Environment Deployment

on:
  push:
    branches:
      # - main # ðŸŒŸ Production (GitHub Pages)
      - feat/multi-arch-deployement
      - develop # ðŸš§ Staging (Cloudflare Pages)
      - "feat/**" # ðŸ” Preview (Cloudflare Pages)
      - "fix/**" # ðŸ› Bugfix Preview
      - "hotfix/**" # ðŸš¨ Hotfix Preview
  pull_request:
    branches: [main, develop, feat/multi-arch-deployement] # ðŸ“ PR Preview (Cloudflare Pages)

env:
  NODE_VERSION: 20
  PNPM_VERSION: 8
  NPM_CONFIG_FUND: false
  NPM_CONFIG_AUDIT: false

jobs:
  # ==========================================
  # ðŸ” DÃ‰TECTION DES CHANGEMENTS
  # ==========================================
  detect-changes:
    name: ðŸ” Smart Change Detection
    runs-on: ubuntu-latest
    outputs:
      main-site: ${{ steps.changes.outputs.main-site }}
      blog: ${{ steps.changes.outputs.blog }}
      any-change: ${{ steps.changes.outputs.main-site == 'true' || steps.changes.outputs.blog == 'true' }}

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Analyze file changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            main-site:
              - 'apps/eembouz.com/**'
              - 'packages/**'
              - 'turbo.json'
            blog:
              - 'apps/blog.eembouz.com/**'
              - 'packages/**'
              - 'turbo.json'

  # ==========================================
  # ðŸ§ª TESTS DE QUALITÃ‰ (SIMPLIFIÃ‰)
  # ==========================================
  quality-gate:
    name: ðŸ§ª Quality Gate
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-change == 'true'

    steps:
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: ðŸ“¦ Install dependencies
        run: pnpm install

      - name: âœ… Basic validation
        run: |
          echo "âœ… Dependencies installed successfully"
          echo "âœ… Ready for build phase"

  # ==========================================
  # ðŸ”¨ BUILD APPLICATIONS
  # ==========================================
  build-apps:
    name: ðŸ”¨ Build Applications
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-gate]
    if: needs.detect-changes.outputs.any-change == 'true'

    strategy:
      matrix:
        app: [main-site, blog]
        include:
          - app: main-site
            condition: needs.detect-changes.outputs.main-site == 'true'
            filter: eembouz.com
            build-dir: apps/eembouz.com/dist
          - app: blog
            condition: needs.detect-changes.outputs.blog == 'true'
            filter: blog.eembouz.com
            build-dir: apps/blog.eembouz.com/dist

    steps:
      - name: â­ï¸ Skip if no changes
        if: ${{ !fromJson(matrix.condition) }}
        run: echo "â­ï¸ No changes for ${{ matrix.app }}, skipping..."

      - name: ðŸ“‚ Checkout repository
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/checkout@v4

      - name: âš¡ Setup pnpm
        if: ${{ fromJson(matrix.condition) }}
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: ðŸ“¦ Install dependencies
        if: ${{ fromJson(matrix.condition) }}
        run: pnpm install

      - name: ðŸ”¨ Build application
        if: ${{ fromJson(matrix.condition) }}
        run: |
          echo "ðŸ”¨ Building ${{ matrix.app }}..."
          pnpm turbo run build --filter=${{ matrix.filter }}

      - name: ðŸ“¦ Upload build artifacts
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-build-${{ github.sha }}
          path: ${{ matrix.build-dir }}
          retention-days: 3

  # ==========================================
  # ðŸš€ PRODUCTION (GitHub Pages - main branch)
  # ==========================================
  deploy-production:
    name: ðŸš€ Deploy Production (GitHub Pages)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-apps]
    if: |
      needs.detect-changes.outputs.any-change == 'true' && 
      github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://eembouz.com

    strategy:
      matrix:
        app: [main-site, blog]
        include:
          - app: main-site
            condition: needs.detect-changes.outputs.main-site == 'true'
            repo: elyseemb/eembouz.com
            domain: eembouz.com
          - app: blog
            condition: needs.detect-changes.outputs.blog == 'true'
            repo: elyseemb/blog.eembouz.com
            domain: blog.eembouz.com

    steps:
      - name: â­ï¸ Skip if no changes
        if: ${{ !fromJson(matrix.condition) }}
        run: echo "â­ï¸ No changes for ${{ matrix.app }}, skipping production..."

      - name: ðŸ“¥ Download build artifacts
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.app }}-build-${{ github.sha }}
          path: ./dist

      - name: ðŸš€ Deploy to GitHub Pages
        if: ${{ fromJson(matrix.condition) }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: ${{ matrix.repo }}
          publish_dir: ./dist
          publish_branch: main
          cname: ${{ matrix.domain }}
          commit_message: "ðŸš€ Production: ${{ github.sha }}"

  # ==========================================
  # ðŸš§ STAGING (Cloudflare Pages - develop branch)
  # ==========================================
  deploy-staging:
    name: ðŸš§ Deploy Staging (Cloudflare Pages)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-apps]
    if: |
      needs.detect-changes.outputs.any-change == 'true' && 
      github.ref == 'refs/heads/develop'

    environment:
      name: staging
      url: https://staging.eembouz.com

    strategy:
      matrix:
        app: [main-site, blog]
        include:
          - app: main-site
            condition: needs.detect-changes.outputs.main-site == 'true'
            project-name: eembouz-staging
            subdomain: staging
          - app: blog
            condition: needs.detect-changes.outputs.blog == 'true'
            project-name: blog-eembouz-staging
            subdomain: staging-blog

    steps:
      - name: â­ï¸ Skip if no changes
        if: ${{ !fromJson(matrix.condition) }}
        run: echo "â­ï¸ No changes for ${{ matrix.app }}, skipping staging..."

      - name: ðŸ“¥ Download build artifacts
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.app }}-build-${{ github.sha }}
          path: ./dist

      - name: ðŸš§ Deploy to Cloudflare Pages
        if: ${{ fromJson(matrix.condition) }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ matrix.project-name }}
          directory: ./dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”— Configure custom domain
        if: ${{ fromJson(matrix.condition) }}
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/${{ matrix.project-name }}/domains" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"name":"${{ matrix.subdomain }}.eembouz.com"}'

  # ==========================================
  # ðŸ” PREVIEW (Cloudflare Pages - features + PR)
  # ==========================================
  deploy-preview:
    name: ðŸ” Deploy Preview (Cloudflare Pages)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-apps]
    if: |
      needs.detect-changes.outputs.any-change == 'true' && 
      (startsWith(github.ref, 'refs/heads/feat/') || 
       startsWith(github.ref, 'refs/heads/fix/') || 
       startsWith(github.ref, 'refs/heads/hotfix/') || 
       github.event_name == 'pull_request')

    environment:
      name: preview-${{ github.event.number || github.ref_name }}
      url: https://preview-${{ github.event.number || github.ref_name }}.eembouz.com

    strategy:
      matrix:
        app: [main-site, blog]
        include:
          - app: main-site
            condition: needs.detect-changes.outputs.main-site == 'true'
            project-name: eembouz-preview
            base-domain: preview-${{ github.event.number || github.ref_name }}.eembouz.com
          - app: blog
            condition: needs.detect-changes.outputs.blog == 'true'
            project-name: blog-eembouz-preview
            base-domain: preview-blog-${{ github.event.number || github.ref_name }}.eembouz.com

    steps:
      - name: â­ï¸ Skip if no changes
        if: ${{ !fromJson(matrix.condition) }}
        run: echo "â­ï¸ No changes for ${{ matrix.app }}, skipping preview..."

      - name: ðŸ“¥ Download build artifacts
        if: ${{ fromJson(matrix.condition) }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.app }}-build-${{ github.sha }}
          path: ./dist

      - name: ðŸ” Deploy Preview to Cloudflare Pages
        if: ${{ fromJson(matrix.condition) }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ matrix.project-name }}
          directory: ./dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}

      - name: ðŸ”— Configure preview domain
        if: ${{ fromJson(matrix.condition) }}
        run: |
          # Cloudflare Pages gÃ©nÃ¨re automatiquement des URLs de preview
          # Format: https://{branch}.{project-name}.pages.dev
          echo "ðŸ” Preview deployed to Cloudflare Pages"
          echo "ðŸŒ Auto URL: https://${{ github.ref_name }}.${{ matrix.project-name }}.pages.dev"
          echo "ðŸŒ Custom URL: https://${{ matrix.base-domain }}"

      - name: ðŸ’¬ Comment PR with preview links
        if: ${{ fromJson(matrix.condition) && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const app = '${{ matrix.app }}';
            const projectName = '${{ matrix.project-name }}';
            const branch = '${{ github.ref_name }}';
            const autoUrl = `https://${branch}.${projectName}.pages.dev`;
            const customUrl = `https://${{ matrix.base-domain }}`;

            const comment = `## ðŸ” Preview Ready for ${app}!

            ðŸŒ **Cloudflare URL**: ${autoUrl}
            ðŸŽ¯ **Custom URL**: ${customUrl}
            ðŸ“ **Branch**: \`${branch}\`
            ðŸ“Š **Commit**: \`${{ github.sha }}\`

            âš¡ Powered by Cloudflare Pages
            ðŸ”„ Updates automatically on new commits`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==========================================
  # ðŸ“Š DEPLOYMENT SUMMARY
  # ==========================================
  summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging, deploy-preview]
    if: always()

    steps:
      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒŸ Production (GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Main Site | âœ… | https://eembouz.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | âœ… | https://blog.eembouz.com |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš§ Staging (Cloudflare Pages)" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Main Site | âœ… | https://staging.eembouz.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | âœ… | https://staging-blog.eembouz.com |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Preview (Cloudflare Pages)" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Main Site | âœ… | https://preview-${{ github.ref_name }}.eembouz.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | âœ… | https://preview-blog-${{ github.ref_name }}.eembouz.com |" >> $GITHUB_STEP_SUMMARY
