name: Deployment

on:
  push:
    branches:
      - main
      - feat/multi-arch-deployement
      - develop
      - "feat/**"
      - "fix/**"
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: 20
  PNPM_VERSION: 8

jobs:
  # ==========================================
  # ğŸ”¨ BUILD & DEPLOY
  # ==========================================
  deploy:
    name: ğŸš€ Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸ”¨ Build main site
        run: |
          cd apps/eembouz.com
          pnpm run build

      - name: ğŸ”¨ Build blog
        run: |
          cd apps/blog.eembouz.com
          pnpm run build

      # ==========================================
      # ğŸŒŸ PRODUCTION (main branch)
      # ==========================================
      - name: ğŸš€ Deploy main site to production
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: elyseemb/eembouz.com
          publish_dir: ./apps/eembouz.com/dist
          publish_branch: main
          cname: eembouz.com

      - name: ğŸš€ Deploy blog to production
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PERSONAL_TOKEN }}
          external_repository: elyseemb/blog.eembouz.com
          publish_dir: ./apps/blog.eembouz.com/blog-static
          publish_branch: main
          cname: blog.eembouz.com

      # ==========================================
      # ğŸš§ STAGING (develop branch)
      # ==========================================
      - name: ğŸš§ Deploy main site to staging
        if: github.ref == 'refs/heads/develop'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: eembouz-staging
          directory: ./apps/eembouz.com/dist

      - name: ğŸš§ Deploy blog to staging
        if: github.ref == 'refs/heads/develop'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: blog-eembouz-staging
          directory: ./apps/blog.eembouz.com/blog-static

      # ==========================================
      # ğŸ” PREVIEW (feature branches)
      # ==========================================
      - name: ğŸ” Deploy main site preview
        if: startsWith(github.ref, 'refs/heads/feat/') || startsWith(github.ref, 'refs/heads/fix/')
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: eembouz-staging
          directory: ./apps/eembouz.com/dist

          branch: ${{ github.ref_name }}

      - name: ğŸ” Deploy blog preview
        if: startsWith(github.ref, 'refs/heads/feat/') || startsWith(github.ref, 'refs/heads/fix/')
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: blog-eembouz-staging
          directory: ./apps/blog.eembouz.com/blog-static

          branch: ${{ github.ref_name }}

      - name: âœ… Deployment completed
        run: |
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
